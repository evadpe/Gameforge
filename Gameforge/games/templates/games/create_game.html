{% extends 'games/base.html' %}

{% block title %}Cr√©er un Jeu - GameForge{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8 col-lg-6">
        <div class="card">
            <div class="card-body">
                <h2 class="card-title text-center mb-3">Cr√©er un nouveau jeu</h2>
                
                <div class="alert alert-info mb-3">
                    <strong>G√©n√©rations restantes aujourd'hui:</strong> {{ remaining_generations }}
                </div>

                <form method="post" id="gameForm">
                    {% csrf_token %}
                    
                    <div class="mb-3">
                        <label for="{{ form.genre.id_for_label }}" class="form-label">Genre du jeu</label>
                        {{ form.genre }}
                        {% if form.genre.errors %}
                            <div class="text-danger mt-1">{{ form.genre.errors }}</div>
                        {% endif %}
                    </div>

                    <div class="mb-3">
                        <label for="{{ form.ambiance.id_for_label }}" class="form-label">Ambiance</label>
                        {{ form.ambiance }}
                        {% if form.ambiance.errors %}
                            <div class="text-danger mt-1">{{ form.ambiance.errors }}</div>
                        {% endif %}
                    </div>

                    <div class="mb-3">
                        <label for="{{ form.mots_cles.id_for_label }}" class="form-label">Mots-cl√©s</label>
                        {{ form.mots_cles }}
                        <small class="form-text text-muted">{{ form.mots_cles.help_text }}</small>
                        {% if form.mots_cles.errors %}
                            <div class="text-danger mt-1">{{ form.mots_cles.errors }}</div>
                        {% endif %}
                    </div>

                    <div class="mb-3">
                        <label for="{{ form.references.id_for_label }}" class="form-label">R√©f√©rences culturelles</label>
                        {{ form.references }}
                        <small class="form-text text-muted">{{ form.references.help_text }}</small>
                        {% if form.references.errors %}
                            <div class="text-danger mt-1">{{ form.references.errors }}</div>
                        {% endif %}
                    </div>

                    <div class="mb-3 form-check">
                        {{ form.est_public }}
                        <label class="form-check-label" for="{{ form.est_public.id_for_label }}">
                            {{ form.est_public.label }}
                        </label>
                    </div>

                    <button type="submit" class="btn btn-primary w-100" id="submitBtn">
                        <span id="btnText">G√©n√©rer le jeu</span>
                        <span id="btnSpinner" class="d-none">
                            <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                            G√©n√©ration en cours...
                        </span>
                    </button>
                </form>

                <div class="text-center mt-3">
                    <p class="text-muted mb-2">ou</p>
                    <a href="{% url 'games:create_random_game' %}" class="btn btn-light" id="randomGameLink">
                        G√©n√©ration al√©atoire
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Logique de chargement pour la g√©n√©ration manuelle
document.getElementById('gameForm').addEventListener('submit', function(e) {
    const loadingOverlay = document.getElementById('loading-overlay');
    const progressBar = document.getElementById('progressBar');
    const statusText = document.getElementById('status-text');
    const submitBtn = document.getElementById('submitBtn');
    
    // V√©rifie si l'overlay (d√©fini dans base.html) est disponible
    if (loadingOverlay) {
        submitBtn.disabled = true;
        loadingOverlay.style.display = 'flex';

        // √âtapes de progression pour la g√©n√©ration manuelle
        const steps = [
            { percent: 20, text: "√âtape 1/5 : G√©n√©ration du Titre et de l'Univers..." },
            { percent: 40, text: "√âtape 2/5 : √âcriture du Sc√©nario en 3 actes..." },
            { percent: 60, text: "√âtape 3/5 : Conception des Personnages (3) et Lieux (4)..." },
            { percent: 80, text: "√âtape 4/5 : G√©n√©ration de l'Image Conceptuelle (la plus longue)..." },
            { percent: 95, text: "√âtape 5/5 : Finalisation de la Sauvegarde des donn√©es..." }
        ];

        let currentStep = 0;

        function updateProgress(step) {
            if (step < steps.length) {
                const { percent, text } = steps[step];
                
                progressBar.style.width = percent + '%';
                progressBar.setAttribute('aria-valuenow', percent);
                progressBar.textContent = percent + '%';
                statusText.textContent = text;
                currentStep++;

                // Simuler le temps de chargement
                setTimeout(() => updateProgress(currentStep), 7000); 
            } else {
                progressBar.style.width = '100%';
                progressBar.setAttribute('aria-valuenow', 100);
                progressBar.textContent = '100%';
                statusText.textContent = 'Op√©ration termin√©e. Redirection en cours...';
            }
        }
        
        updateProgress(currentStep);
    }
    // Le formulaire proc√®de √† la soumission POST
});


// LOGIQUE DE CHARGEMENT POUR LE BOUTON AL√âATOIRE (ID: randomGameLink)
document.getElementById('randomGameLink').addEventListener('click', function(e) {
    // 1. Emp√™cher la navigation imm√©diate
    e.preventDefault(); 
    
    const loadingOverlay = document.getElementById('loading-overlay');
    const progressBar = document.getElementById('progressBar');
    const statusText = document.getElementById('status-text');

    if (!loadingOverlay) {
        window.location.href = this.href; 
        return;
    }
    
    // 2. Afficher l'overlay et initialiser la progression
    loadingOverlay.style.display = 'flex';
    
    progressBar.style.width = '10%';
    progressBar.textContent = '10%';
    statusText.textContent = "ü§ñ D√©marrage de la g√©n√©ration al√©atoire...";
    
    // 3. Simuler une progression
    let progress = 10;
    const interval = setInterval(() => {
        if (progress < 95) {
            progress += 5;
            progressBar.style.width = progress + '%';
            progressBar.textContent = progress + '%';
            
            if (progress === 30) {
                statusText.textContent = "üé≤ Choix des param√®tres al√©atoires...";
            } else if (progress === 60) {
                statusText.textContent = "üß† Interrogation de l'IA...";
            } else if (progress === 80) {
                statusText.textContent = "üíæ Sauvegarde en cours...";
            }
        } else {
            clearInterval(interval);
            statusText.textContent = "Op√©ration termin√©e. Redirection en cours...";
        }
    }, 1500); 
    
    // 4. Lancer la navigation r√©elle apr√®s un court d√©lai pour que l'animation d√©marre
    setTimeout(() => {
        window.location.href = this.href;
    }, 500); 
});
</script>

<style>
    form select, form input[type="text"] {
        width: 100%;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 5px;
    }
</style>
{% endblock %}
